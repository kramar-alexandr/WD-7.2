external procedure CurValToOtherCur(Date,string,val,string,var val,roundmode);external procedure CollectCostMyInvoice(record IVVc, integer,var array val,var array val,var array string,var array val,var array date,var array string,var array string,var array val,var integer,integer,longint);external function val CalcSumForSales(val,val,val,val,val,integer, val,boolean);external function string 200 ValToMyString(val,integer);external external procedure ExtractObj(string,var Integer,var string);SetLangMode(LangUkrainian,"UKR",0);procedure OutPutData(date perdate,string object,val datesum,val datesumcurr,val monthsum,val monthsumcurr,boolean repextended)begin  integer pos;        startformat(15);      pos = 0;				  outstring(pos,0,perdate,false);		  if (repextended) then begin		    outstring(pos+=50,0,object,false);		  end;			outstring(pos+=50,0,ValToMyString(datesum,3),false);			outstring(pos+=50,0,ValToMyString(datesumcurr,3),false);			outstring(pos+=50,0,ValToMyString(monthsum,3),false);			outstring(pos+=50,0,ValToMyString(monthsumcurr,3),false);		endformat;    return;end;global //Edit***************************Sasha2,15:13 29.01.2015 {procedure RetailSalesRn(record RcVc RepSpec)begin  record IVVc IVr;	row IVVc IVrw;	record CUVc CUr;  record LocalMachineAccBlock LMAccB;  row LocalMachineAccBlock LMAccBw;  integer mtrw,i,j,cred,pos,ressize,objcnt;  boolean TrHs,testf,repextended;  val invfr,invto1,foundqty,t,sumcur,sumusd;  longint CredInvNo;  date sd,ed,tempdate;  vector longint objectsqueue;  array string 40 objectslist;  string 20 tstr,curobject;  array val datesum,datesumcurr,monthsum,monthsumcurr;  array val rate,qty,cost,curcost;  array date indate;  array string 100 vecode,serial,curncy;    sd = RepSpec.sStartDate;	ed = RepSpec.sEndDate;		if (RepSpec.ArtMode==1) then begin	 repextended = true;	end else begin	 repextended = false;	end;    startreportnoheaderjob("Звіт по роздрібному продажу");    startformat(15);      pos = 0;				  outstring(pos,0,"Дата",false);		  if (repextended) then begin		    outstring(pos+=50,0,"Магазин",false);		  end;			outstring(pos+=50,0,"Сумма,грн.",false);			outstring(pos+=50,0,"Сума,$",false);			outstring(pos+=50,0,"Всього міс,грн.",false);			outstring(pos+=50,0,"Всього міс,$",false);		endformat;				if (repextended) then begin		  objcnt = 0;		  BlockLoad(LMAccB);		  mtrw = MatRowCnt(LMAccB);		  for (i=0;i<mtrw;i=i+1) begin		    MatRowGet(LMAccB,i,LMAccBw);		    if (NonBlank(LMAccBw.Objects) and objectsqueue[LMAccBw.Objects]==-1) then begin		      objectsqueue[LMAccBw.Objects] = objcnt;		      objectslist[objcnt] = LMAccBw.Objects;		      objcnt = objcnt + 1;		    end;		  end;		end else begin		  objcnt = 1;		  curobject = "allobjs";		  objectsqueue[curobject] = 0;		  objectslist[0] = "allobjs";		end;				ClearArray(datesum);		ClearArray(datesumcurr);		ClearArray(monthsum);		ClearArray(monthsumcurr);		TrHs = true;  	IVr.InvDate = sd;  	while(loopkey("InvDate",IVr,1,TrHs)) begin  		testf = true;  		if(IVr.InvDate>ed)then begin TrHs = false; testf = false; end;  		if(IVr.Invalid==1)then begin testf = false; end;  		if(IVr.OKFlag==0)then begin testf = false; end;  		  		cred = 1;  		if(IVr.InvType==3) then begin         cred=-1;        matRowGet(IVr,0,IVrw);        if(IVrw.stp==3) then begin          CredInvNo = IVrw.OrdRow;        end;      end;            if (repextended) then begin        curobject = "";				if(nonblank(IVr.Objects))then begin					pos = 0;					tstr = "";					ExtractObj(IVr.Objects,pos,tstr);					While (nonblank(tstr)) begin						if(nonblank(tstr) and objectsqueue[tstr]>-1)then begin						  curobject = tstr;						  pos = 255;						end;						ExtractObj(IVr.Objects,pos,tstr);					end;				end;			end;            If(testf) then begin        if (NonBlankDate(tempdate)) then begin          for (i=0;i<objcnt;i=i+1) begin            if (tempdate!=IVr.InvDate) then begin              OutPutData(IVr.InvDate,objectslist[i],datesum[i],datesumcurr[i],monthsum[i],monthsumcurr[i],repextended);              datesum[i] = 0;		          datesumcurr[i] = 0;            end;            if (GetMonth(tempdate)!=GetMonth(IVr.InvDate)) then begin              monthsum[i] = 0;		          monthsumcurr[i] = 0;            end;          end;        end;			  invfr = IVr.FrRate;  			invto1 = IVr.ToRateB1;  			if(invfr==0 or invto1==0)then begin  				invfr = 1;  				invto1 = 1;  			end;  						  mtrw = matrowcnt(IVr);			  For(i=0;i<mtrw;i=i+1) begin			    matrowget(IVr,i,IVrw);			    if(IVrw.stp==kInvoiceRowTypeNormal and nonblank(IVrw.ArtCode))then begin			      CollectCostMyInvoice(IVr,i,cost,curcost,curncy,rate,indate,vecode,serial,qty,ressize,cred,CredInvNo);			      foundqty = 0;  					For(j=0;j<ressize;j=j+1) begin  						foundqty = foundqty + qty[j];  					end;  					For(j=0;j<ressize;j=j+1) begin	  							if (Left(IVr.CurncyCode,3)=="UAH") then begin  							  sumcur = CalcSumForSales(IVrw.Sum,IVrw.Quant,qty[j],1,1,cred,foundqty,false);  							end else begin  							  CUr.Code = IVr.CustCode;			            readfirstmain(CUr,1,true);  							  if (IVr.CurncyCode=="USD") then begin  							    sumcur = CalcSumForSales(IVrw.Sum,IVrw.Quant,qty[j],1,1,cred,foundqty,false);  							    CurValToOtherCur(indate[j],IVr.CurncyCode,sumcur,CUr.CurncyCode,t,DefaultCurRoundOff);  							    sumcur = t;  							  end else begin  							    if (Left(IVr.CurncyCode,3)=="EUR") then begin  							      sumcur = CalcSumForSales(IVrw.Sum,IVrw.Quant,qty[j],1,1,cred,foundqty,false);  							      CurValToOtherCur(indate[j],IVr.CurncyCode,sumcur,"USD",t,DefaultCurRoundOff);  							      sumcur = t;  							      CurValToOtherCur(indate[j],"USD",sumcur,CUr.CurncyCode,t,DefaultCurRoundOff);  							      sumcur = t;  							        							    end;  							  end;  							end;  							  							if(curncy[j]=="USD")then begin  								sumusd = CalcSumForSales(IVrw.Sum,IVrw.Quant,qty[j],invfr,invto1,cred,foundqty,false);  							end else begin  								if(IVr.CurncyCode=="USD")then begin  									sumusd = CalcSumForSales(IVrw.Sum,IVrw.Quant,qty[j],1,1,cred,foundqty,false);  								end else begin  									sumusd = CalcSumForSales(IVrw.Sum,IVrw.Quant,qty[j],1,1,cred,foundqty,false);  									CurValToOtherCur(indate[j],IVr.CurncyCode,sumusd,"USD",t,DefaultCurRoundOff);  									sumusd = t;  								end;  							end;  					end;  					  					if (NonBlank(curobject)) then begin  					  datesum[objectsqueue[curobject]] = datesum[objectsqueue[curobject]] + sumcur;  					  monthsum[objectsqueue[curobject]] = monthsum[objectsqueue[curobject]] + sumcur;  					  datesumcurr[objectsqueue[curobject]] = datesumcurr[objectsqueue[curobject]] + sumusd;  					  monthsumcurr[objectsqueue[curobject]] = monthsumcurr[objectsqueue[curobject]] + sumusd;  					end;  					  					if(foundqty*cred<IVrw.Quant)then begin  							if (Left(IVr.CurncyCode,3)=="UAH") then begin  							  sumcur = CalcSumForSales(IVrw.Sum,IVrw.Quant,0,1,1,cred,foundqty,true);  							end else begin  							  if (IVr.CurncyCode=="USD") then begin  							    sumcur = CalcSumForSales(IVrw.Sum,IVrw.Quant,0,invto1,invfr,cred,foundqty,true);  							  end else begin  							    if (Left(IVr.CurncyCode,3)=="EUR") then begin  							      sumcur = CalcSumForSales(IVrw.Sum,IVrw.Quant,0,invto1,invfr,cred,foundqty,true);  							      CurValToOtherCur(IVr.InvDate,"USD",sumcur,CUr.CurncyCode,t,DefaultCurRoundOff);  							      sumcur = t;  							    end;  							  end;  							end;  							sumusd = CalcSumForSales(IVrw.Sum,IVrw.Quant,0,invfr,invto1,cred,foundqty,true);  							  							if (NonBlank(curobject)) then begin  							  datesum[objectsqueue[curobject]] = datesum[objectsqueue[curobject]] + sumcur;  							  monthsum[objectsqueue[curobject]] = monthsum[objectsqueue[curobject]] + sumcur;  					      datesumcurr[objectsqueue[curobject]] = datesumcurr[objectsqueue[curobject]] + sumusd;  					      monthsumcurr[objectsqueue[curobject]] = monthsumcurr[objectsqueue[curobject]] + sumusd;  					    end;    					end;			    end;			  end;        tempdate = IVr.InvDate;      end;    end;		for (i=0;i<objcnt;i=i+1) begin		  if (datesum[i]<>0) then begin		    OutPutData(IVr.InvDate,objectslist[i],datesum[i],datesumcurr[i],monthsum[i],monthsumcurr[i],repextended);		  end;    end;	endjob;return;end; //Edit***************************Sasha2,15:14 29.01.2015 }