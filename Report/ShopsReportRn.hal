SetLangMode(LangUkrainian,"UKR",0);external procedure CollectSerials(var record StockMovVc,var row StockMovVc,string,string,integer);global procedure ShopsReportRn(record RcVc RepSpec)begin	integer i,mtrw,outpos,rwcnt1,j,rownr,company,k,sercnt;	record ORVc ORr;	row ORVc ORrw;	boolean TrHs,testf,testf1;	date sd,ed;	record INVc INr;	record StockMovVc StockMovr,StockMov2r; 	row StockMovVc StockMovrw, StockMov2rw; 	record SHVc SHr; 	row SHVc SHrw; 	record RetVc Retr; 	row RetVc Retrw;	val itemqty;		sd = RepSpec.sStartDate;	ed = RepSpec.sEndDate;	outpos = 0;		startreportnoheaderjob("Визначте звіт по Shops");		startformat(15);					outstring(outpos,0,USetStr(2354),false); //Клієнт			outstring(outpos+=30,0,USetStr(2326),false); // Найменування			outstring(outpos+=40,0,USetStr(2407),false); //Рахунок			outstring(outpos+=30,0,USetStr(5332),false); //Вид			outstring(outpos+=30,0,USetStr(2569),false); //Склад			outstring(outpos+=30,0,USetStr(2353),false); //Дата			outstring(outpos+=30,0,"Артикул",false);			outstring(outpos+=30,0,USetStr(3364),false); //опис			outstring(outpos+=50,0,USetStr(5018),false); //Серійний номер			outstring(outpos+=30,0,USetStr(5279),false); //Кількість			outstring(outpos+=30,0,USetStr(2335),false); //Ціна			outstring(outpos+=30,0,USetStr(2449),false); //Знижка			outstring(outpos+=30,0,USetStr(16018),false); //Валюта			outstring(outpos+=30,0,USetStr(9342),false); //Менеджер			outstring(outpos+=30,0,"Бренд",false);		endformat;		TrHs = true;	ORr.OrdDate = sd;	while(loopkey("OrdDate",ORr,1,TrHs))begin		testf = true;		if(ORr.OrdDate>ed)then begin TrHs = false; testf = false; end;		if(ORr.OKFlag==0)then begin testf = false; end;		if(ORr.OrderClass!="Shops")then begin testf = false; end;		if(NonBlank(RepSpec.f1) and !SetInSet(ORr.CustCode,RepSpec.f1))then begin testf = false; end;				If(testf) then begin			RECORDNEW(StockMov2r);			StockMovr.OrderNr = ORr.SerNr;		  	if (ReadFirstKey("OrderNr",StockMovr,1,true)) then begin			mtrw = matrowcnt(ORr);				For(i=0;i<mtrw;i=i+1) begin					testf = true;					itemqty = 0;					matrowget(ORr,i,ORrw);					if(blank(ORrw.ArtCode) or (ORrw.Quant - ORrw.Shipd2)==0)then begin testf = false; end;					if(nonblank(RepSpec.f2) and !SetInSet(ORrw.ArtCode,RepSpec.f2))then begin testf = false; end;					if (testf) then begin	  						while (LoopKey("OrderNr",StockMovr,1,true)) begin	  							if (StockMovr.OrdFlag==1 and StockMovr.OKFlag==1 and StockMovr.OrderNr==ORr.SerNr) then begin			  						rwcnt1=MatRowCnt(StockMovr);			  						for (j=0;j<rwcnt1;j=j+1) begin			  							MatRowGet(StockMovr,j,StockMovrw);		  								testf1 = true;		  								if (StockMovrw.ArtCode!=ORrw.ArtCode or StockMovrw.ORRow!=i) then begin testf1 = false; end;		  								if (testf1) then begin											if (StockMovr.ToLocation==ORr.Location) then begin					  							itemqty = itemqty + StockMovrw.Quant;					  							if (NonBlank(StockMovrw.SerialNr)) then begin					  								CollectSerials(StockMov2r,StockMov2rw,StockMovrw.ArtCode,StockMovrw.SerialNr,1);					  							end;					  						end;					  						if (StockMovr.FrLocation==ORr.Location) then begin					  							itemqty = itemqty - StockMovrw.Quant;					  							if (NonBlank(StockMovrw.SerialNr)) then begin					  								CollectSerials(StockMov2r,StockMov2rw,StockMovrw.ArtCode,StockMovrw.SerialNr,-1);					  							end;					  						end; 										end;		  							end;		  						end;	  						end; RESETLOOP(StockMovr);	  							  					SHr.OrderNr = ORr.SerNr;						TrHs = true;						while (LoopKey("OrderKey",SHr,1,TrHs)) begin							if (SHr.OKFlag==1 and SHr.OrderNr==ORr.SerNr) then begin								rwcnt1=MatRowCnt(SHr);								for (j=0;j<rwcnt1;j=j+1) begin									MatRowGet(SHr,j,SHrw);									testf1 = true; 									if (SHrw.ArtCode!=ORrw.ArtCode or SHrw.OrdRow!=i) then begin testf1 = false; end;									if (testf1) then begin				  						itemqty = itemqty - SHrw.Ship;				  						if (NonBlank(SHrw.SerialNr)) then begin			  								CollectSerials(StockMov2r,StockMov2rw,StockMovrw.ArtCode,SHrw.SerialNr,-1);			  							end; 									end;								end;							end;						end; RESETLOOP(SHr);												Retr.OrdNr = ORr.SerNr;						TrHs = true;						while (LoopKey("OrdNr",Retr,1,TrHs)) begin							if (Retr.OKFlag==1 and Retr.OrdNr==ORr.SerNr and Retr.Location==ORr.Location) then begin								rwcnt1=MatRowCnt(Retr);								for (j=0;j<rwcnt1;j=j+1) begin									MatRowGet(Retr,j,Retrw);									testf1 = true;									if (Retrw.ArtCode!=ORrw.ArtCode or Retrw.OrdRow!=i) then begin testf1 = false; end;									if (testf1) then begin				  						itemqty = itemqty + Retrw.Quant;				  						if (NonBlank(Retrw.SerialNr)) then begin			  								CollectSerials(StockMov2r,StockMov2rw,StockMovrw.ArtCode,Retrw.SerialNr,1);			  							end;									end;								end;							end;						end; RESETLOOP(Retr);		  					if (itemqty > 0) then begin	  						INr.Code = ORrw.ArtCode;	  						ReadFirstMain(INr,1,true);	  						if (INr.SerNrf == 1) then begin	  							sercnt = MatRowCnt(StockMov2r);	  							for (k=0;k<sercnt;k=k+1) begin	  								MatRowGet(StockMov2r,k,StockMov2rw);	  								if (StockMov2rw.ArtCode==ORrw.ArtCode and StockMov2rw.Quant>0) then begin		  									outpos = 0;				  						startformat(15);													outstring(outpos,0,ORr.CustCode,false);											outstring(outpos+=30,0,ORr.Addr0,false); 											outstring(outpos+=40,"DblORVc",ORr.SerNr,false);											outstring(outpos+=30,0,ORr.OrderClass,false); 											outstring(outpos+=30,0,ORr.Location,false);											outstring(outpos+=30,0,ORr.OrdDate,false);											outstring(outpos+=30,0,ORrw.ArtCode,false);											outstring(outpos+=30,0,ORrw.Spec,false);											outstring(outpos+=50,0,StockMov2rw.SerialNr,false);											outstring(outpos+=30,0,"1",false); 											outstring(outpos+=30,0,ORrw.Price,false);											outstring(outpos+=30,0,ORrw.vRebate,false);											outstring(outpos+=30,0,ORr.CurncyCode,false);											outstring(outpos+=30,0,ORr.SalesMan,false);											outstring(outpos+=30,0,INr.DispGroups,false);										endformat;					  					end;			  					end;			  					end else begin								outpos = 0;		  						startformat(15);											outstring(outpos,0,ORr.CustCode,false);									outstring(outpos+=30,0,ORr.Addr0,false); 									outstring(outpos+=40,"DblORVc",ORr.SerNr,false);									outstring(outpos+=30,0,ORr.OrderClass,false); 									outstring(outpos+=30,0,ORr.Location,false);									outstring(outpos+=30,0,ORr.OrdDate,false);									outstring(outpos+=30,0,ORrw.ArtCode,false);									outstring(outpos+=30,0,ORrw.Spec,false);									outstring(outpos+=50,0,ORrw.SerialNr,false);									outstring(outpos+=30,0,itemqty,false); 									outstring(outpos+=30,0,ORrw.Price,false);									outstring(outpos+=30,0,ORrw.vRebate,false);									outstring(outpos+=30,0,ORr.CurncyCode,false);									outstring(outpos+=30,0,ORr.SalesMan,false);									outstring(outpos+=30,0,INr.DispGroups,false);								endformat;		  					end;		  					end;					end;	  				end;			end;			 		end; 	end;		endjob;return;end;