external procedure ExtractObj(string,var Integer,var string);external function val AbsoluteVal(val);external function roundmode SetRoundModeD(Integer);external function Boolean IsDigit(string);external procedure ExtractObjWithSeparator(string,string,Boolean,var Integer,var string);SetLangMode(LangRussian,"UKR",0);global function string 255 NewM4PadString(string instr,Integer padlen,string padchar,Boolean padleft)BEGIN  string 255 tstr,t2;  Integer i;  Integer toff;    toff = 0;  for (i = 1; i<=padlen ;i=i+1) begin tstr = tstr & padchar; end;  if (padleft) then begin    tstr = tstr & instr;    tstr = Right(tstr,(len(tstr)-len(instr)));      end else begin    t2 = tstr;    tstr = instr;    tstr = tstr & t2;    tstr = Left(tstr,padlen);  end;    NewM4PadString = tstr;  RETURN;END;function boolean IsStringNumeric(string s)begin  integer i;  boolean res;    res = true;  for (i=0;i<len(s);i=i+1) begin    if (IsDigit(mid(s,i,1))==false) then begin      res = false;      i = len(s)+1;    end;  end;    IsStringNumeric = res;  return;end;function boolean SamsungSalesOldRun(record RcVc RepSpec,record SamsungSettingsBlock SFtpb,var string outfile)begin  record IVVc IVr;  record INVc INr;  row IVVc IVrw;  date sd,ed;  time curtime;  string 255 filename,senderCode,locations;  boolean TrHs,testf,initfile,res;  string 20 timeStamp;  area ames;  integer i,rwcnt;  string 4 linefeed,padchar;		 res = false;	 outfile = "";	 linefeed = Chr(10); 	 padchar = " ";	 	 sd = RepSpec.sStartDate;	 ed = RepSpec.sEndDate;	 locations = SFtpb.Locations;	 if (blank(locations)) then begin	   goto LSamsungSalesOldRun;	 end; 		 if (BlankDate(sd)) then begin		 sd = CurrentDate;	 end;	 if (BlankDate(ed)) then begin		 ed = CurrentDate;	 end;	 LogText(0,"Period " & sd & ":" & ed);		 timeStamp = DateToString(CurrentDate,"YYYYMMDD");	 curtime = CurrentTime;	 if (len(GetHour(curtime))==1) then begin	   timeStamp = timeStamp & "0" & GetHour(curtime);	 end else begin	   timeStamp = timeStamp & GetHour(curtime);	 end;	 if (len(GetMinute(curtime))==1) then begin	   timeStamp = timeStamp & "0" & GetMinute(curtime);	 end else begin	   timeStamp = timeStamp & GetMinute(curtime);	 end;	 if (len(GetSecond(curtime))==1) then begin	   timeStamp = timeStamp & "0" & GetSecond(curtime);	 end else begin	   timeStamp = timeStamp & GetSecond(curtime);	 end;	 senderCode = SFtpb.SenderCode;	 filename = "PCISTD2.C962." & senderCode & "." & timeStamp & ".txt";	 outfile = filename;	 CreateFile(filename);	 CloseFile;	 	 //Header   AddTextToArea(NewM4PadString("C962",4,padchar,false), ames); //SECCOD   AddTextToArea(NewM4PadString("S",4,padchar,false), ames); //DOCCAT   AddTextToArea(NewM4PadString(SFtpb.SenderName,50,padchar,false), ames); //SNDNAM   AddTextToArea(NewM4PadString("ST",2,padchar,false), ames); //SNDTYP   AddTextToArea(NewM4PadString(senderCode,50,padchar,false), ames); //SNDCOD   AddTextToArea(NewM4PadString(SFtpb.SalesNextDocNum,14,padchar,false), ames); //DOCNUM //should be some increment???   AddTextToArea(NewM4PadString(DateToString(CurrentDate,"YYYYMMDD"),8,padchar,false), ames); //DOCDAT   AddTextToArea("Z" & linefeed, ames); //HDRFLG	 	 TrHs = true;	 IVr.TransDate = sd;	 While(LoopKey("TransDate",IVr,1,TrHs)) begin	   testf = true;	   if (blank(IVr.Location) or SetinSet(IVr.Location,locations)==false) then begin testf = false; end;	 	 if (IVr.TransDate<sd) then begin testf = false; end;	 	 if (IVr.TransDate>ed) then begin TrHs = false; testf = false; end;	 	 if (testf) then begin		 	 //if(IVr.InvType==kInvoiceTypeCredit or IVr.InvType==kInvoiceTypeCreditSpecialSales)then begin sign=-1; end;			  rwcnt = MatRowCnt(IVr);			  for(i=0;i<rwcnt;i=i+1) begin				  MatRowGet(IVr,i,IVrw);				  if (IVrw.stp==kInvoiceRowTypeNormal and NonBlank(IVrw.ArtCode)) then begin				 	  INr.Code = IVrw.ArtCode;				 	  ReadFirstMain(INr,1,true);				 	  if (nonblank(INr.EUCodex)) then begin    				 	if (initfile==false) then begin                initfile = true;              end;  				 	  AddTextToArea(NewM4PadString(senderCode,10,padchar,false), ames); //PTNCOD  				 	  AddTextToArea(NewM4PadString(DateToString(IVr.TransDate,"YYYYMMDD"),8,padchar,false), ames); //ITMDAT  				 	  AddTextToArea(NewM4PadString("",8,padchar,false), ames); //STADAT  				 	  AddTextToArea(NewM4PadString("",8,padchar,false), ames); //ENDDAT  				 	  AddTextToArea(NewM4PadString(INr.EUCodex,20,padchar,false), ames); //SECMOD  				 	  AddTextToArea(NewM4PadString(INr.BarCode,20,padchar,false), ames); //EANUPC  				 	  AddTextToArea(NewM4PadString(INr.Code,30,padchar,false), ames); //PTNMOD  				 	  AddTextToArea(NewM4PadString(IVr.Location,30,padchar,false), ames); //LOCCOD  				 	  AddTextToArea(NewM4PadString("ST",2,padchar,false), ames); //LOCTYP  				 	  AddTextToArea(NewM4PadString("",20,padchar,false), ames); //CHNSRC  				 	  AddTextToArea(NewM4PadString("",20,padchar,false), ames); //CHNCAT  				 	  AddTextToArea(NewM4PadString("",20,padchar,false), ames); //PTN2CD  				 	  AddTextToArea(NewM4PadString("",20,padchar,false), ames); //PTNAGT  				 	  if (IVr.InvType==kInvoiceTypeCredit or IVr.InvType==kInvoiceTypeCreditSpecialSales or IVrw.Quant<0) then begin  				 	    AddTextToArea(NewM4PadString("SR",10,padchar,false), ames); //QTYTYP  				 	  end else begin  				 	    AddTextToArea(NewM4PadString("SN",10,padchar,false), ames); //QTYTYP  				 	  end;  				 	  AddTextToArea(NewM4PadString(AbsoluteVal(IVrw.Quant),10,padchar,false), ames); //QTY  				 	  AddTextToArea(NewM4PadString("",10,padchar,false), ames); //AMT  				 	  AddTextToArea(NewM4PadString("",3,padchar,false), ames); //CUR  				 	  AddTextToArea(NewM4PadString("",50,padchar,false), ames); //RESRV1  				 	  AddTextToArea(NewM4PadString("",50,padchar,false), ames); //RESRV2  				 	  AddTextToArea(NewM4PadString("",50,padchar,false), ames); //RESRV3  				 	  AddTextToArea(NewM4PadString("",50,padchar,false), ames); //RESRV4  				 	  AddTextToArea("Z" & linefeed, ames); //ITMFLG  				 	  end;				  end;			 end;  			 end;	 end;	 	 if (initfile) then begin	   WriteAreaToFile(ames,filename,0);	   res = true;	 end;	 LSamsungSalesOldRun:;  SamsungSalesOldRun = res;  return;end;/*global updating procedure SamsungSendFilesToFtpMn(record RcVc RepSpec)begin  string 255 tstr,outsalesfile;  Boolean sendf;  record SamsungSettingsBlock SFtpb;    BlockLoad(SFtpb);  if (Blank(SFtpb.HostIP) or Blank(SFtpb.DirName) or Blank(SFtpb.Port)) then begin	 goto LSamsungSendFilesToFtpMn;	end;	if (SFtpb.SalesNextDocNum<=0) then begin	  SFtpb.SalesNextDocNum = 1;	end;		if (SamsungSalesOldRun(RepSpec,SFtpb,outsalesfile)) then begin	  SFtpb.SalesNextDocNum = SFtpb.SalesNextDocNum + 1;	  sendf = true;	end;	if (sendf) then begin	  tstr = SFtpb.HostIP & " " & SFtpb.Port & " ";  	if (NonBlank(SFtpb.Login)) then begin  	  tstr = tstr & SFtpb.Login & " ";  	end else begin  	  tstr = tstr & "anonymous ";  	end;  	if (NonBlank(SFtpb.Password)) then begin  	  tstr = tstr & SFtpb.Password & " ";  	end else begin  	  tstr = tstr & "password ";  	end;  	tstr = tstr & SFtpb.DirName & " " & outsalesfile;  	  	millisleep(500);  	RunProgram("./ftptransfer.sh", tstr);	end;		BlockStore(SFtpb);   LSamsungSendFilesToFtpMn:;      return;end;*/global updating procedure SamsungSendFilesByMailMn(record RcVc RepSpec)begin  record SamsungSettingsBlock SFtpb;  record IVcashVc IVcashr;  record INVc INr;  record SysFormatBlock SysFormatRec;  record ItemStatusVc ISr;  row IVcashVc IVcashrw;  date sd,ed;  string 255 locations,mailSubject,tstr,curindex;  boolean TrHs,testf;  string 30 salesdate,itemCode,identificator;  integer i,rwcnt,pos,invoiceCnt;  vector val qtySetCodes,qtyAccesSumsCodes,qtyAccesOthersCodes;  vector val qtySetList,qtyAccesSumsList,qtyAccesOthersList;  vector LongInt serNrSetCodes, serNrAccesSumsCodes, serNrAccesOthersCodes;  vector val priceSetCodes, priceAccesSumsCodes, priceAccesOthersCodes;  array string 255 indexes;      BlockLoad(SFtpb);    if (blank(SFtpb.Locations) or blank(SFtpb.DirName)) then begin  	  goto LSamsungSendFilesByMailMn;  	end;    sd = RepSpec.sStartDate;  	ed = RepSpec.sEndDate;  	locations = SFtpb.Locations; //for now only one location is allowed  	    	  	if (BlankDate(sd)) then begin  		sd = CurrentDate;  	end;  	if (BlankDate(ed)) then begin  	 ed = sd;  	end;  	LogText(0,"Period " & sd & ":" & ed);  	   	salesdate = DateToString(sd,"YYYYMMDD");  	     mailSubject = "[EDI_SELL_OUT] " & SFtpb.SenderName & " " & salesdate;    TrHs = true;  	IVcashr.TransDate = sd;  	invoiceCnt = 0;  	While(LoopKey("TransDate",IVcashr,1,TrHs)) begin  	  testf = true;  	  if (blank(IVcashr.Location) or IVcashr.Location!=locations) then begin testf = false; end;  	 	if (IVcashr.TransDate<sd) then begin testf = false; end;  	 	if (IVcashr.TransDate>ed) then begin TrHs = false; testf = false; end;  	 	if (testf) then begin  	 	  invoiceCnt = invoiceCnt + 1;  	 	  //if(IVcashr.InvType==kInvoiceTypeCredit or IVcashr.InvType==kInvoiceTypeCreditSpecialSales)then begin sign=-1; end;  		  rwcnt = MatRowCnt(IVcashr);  		  for(i=0;i<rwcnt;i=i+1) begin  			  MatRowGet(IVcashr,i,IVcashrw);  			  if (IVcashrw.stp==kInvoiceRowTypeNormal and NonBlank(IVcashrw.ArtCode)) then begin  			 	  INr.Code = IVcashrw.ArtCode;  			 	  ReadFirstMain(INr,1,true);  			 	  if (INr.Group=="SAMSU") then begin //SET  			 	    if ((NonBlank(IVcashrw.SerialNr) or NonBlank(IVcashrw.IMEI)) and  			 	        (NonBlank(INr.EUCodex) or (NonBlank(INr.BarCode) and len(INr.BarCode)==13) and IsStringNumeric(INr.BarCode))) then begin      			 	  if (NonBlank(IVcashrw.IMEI)) then begin      			 	    curindex = IVcashrw.ArtCode & ";" & IVcashrw.IMEI;      			 	    //vectors for sale			 	          if (IVcashrw.Quant>0) then begin  				 	        qtySetCodes[curindex] = qtySetCodes[curindex] + IVcashrw.Quant;  				 	        serNrSetCodes[curindex] = IVcashr.SerNr;  				 	        priceSetCodes[curindex] = IVcashrw.Price;        			 	  end else begin        			 	    qtySetCodes[curindex] = qtySetCodes[curindex] - IVcashrw.Quant;        			 	  end;			 	        end else begin			 	          curindex = IVcashrw.ArtCode & ";" & IVcashrw.SerialNr; 			 	          //vectors for sale			 	          if (IVcashrw.Quant>0) then begin  				 	        qtySetCodes[curindex] = qtySetCodes[curindex] + IVcashrw.Quant;  				 	        serNrSetCodes[curindex] = IVcashr.SerNr;  				 	        priceSetCodes[curindex] = IVcashrw.Price;        			 	  end else begin        			 	    qtySetCodes[curindex] = qtySetCodes[curindex] - IVcashrw.Quant;        			 	  end;			 	        end;			 	        //vector for inventory			 	        if (NonBlank(INr.EUCodex)) then begin 			 	          curindex = IVcashrw.ArtCode & ";" & INr.EUCodex;			 	          if (IVcashrw.Quant>0) then begin			 	            qtySetList[curindex] = qtySetList[curindex] + IVcashrw.Quant; 			 	          end else begin			 	            qtySetList[curindex] = qtySetList[curindex] - IVcashrw.Quant;			 	          end;			 	        end else begin			 	          curindex = IVcashrw.ArtCode & ";" & INr.BarCode;			 	          if (IVcashrw.Quant>0) then begin			 	            qtySetList[curindex] = qtySetList[curindex] + IVcashrw.Quant;			 	          end else begin			 	            qtySetList[curindex] = qtySetList[curindex] - IVcashrw.Quant;			 	          end;			 	        end;  			 	    end;  			 	  end else begin //Accessory  			 	    if (INr.Group=="SAM_A") then begin  			 	      if (NonBlank(INr.EUCodex) or (NonBlank(INr.BarCode) and len(INr.BarCode)==13) and IsStringNumeric(INr.BarCode)) then begin  			 	        if (NonBlank(INr.EUCodex)) then begin        			 	    curindex = IVcashrw.ArtCode & ";" & INr.EUCodex;        			 	    //vectors for sale  			 	          if (IVcashrw.Quant>0) then begin    				 	        qtyAccesSumsCodes[curindex] = qtyAccesSumsCodes[curindex] + IVcashrw.Quant;    				 	        serNrAccesSumsCodes[curindex] = IVcashr.SerNr;    				 	        priceAccesSumsCodes[curindex] = IVcashrw.Price;          			 	  end else begin          			 	    qtyAccesSumsCodes[curindex] = qtyAccesSumsCodes[curindex] - IVcashrw.Quant;          			 	  end;  			 	        end else begin  			 	          curindex = IVcashrw.ArtCode & ";" & INr.BarCode;  			 	          //vectors for sale  			 	          if (IVcashrw.Quant>0) then begin    				 	        qtyAccesSumsCodes[curindex] = qtyAccesSumsCodes[curindex] + IVcashrw.Quant;    				 	        serNrAccesSumsCodes[curindex] = IVcashr.SerNr;    				 	        priceAccesSumsCodes[curindex] = IVcashrw.Price;          			 	  end else begin          			 	    qtyAccesSumsCodes[curindex] = qtyAccesSumsCodes[curindex] - IVcashrw.Quant;          			 	  end;  			 	        end;  			 	        //vector for inventory  			 	        if (NonBlank(INr.EUCodex)) then begin   			 	          curindex = IVcashrw.ArtCode & ";" & INr.EUCodex;  			 	          if (IVcashrw.Quant>0) then begin  			 	            qtyAccesSumsList[curindex] = qtyAccesSumsList[curindex] + IVcashrw.Quant;   			 	          end else begin  			 	            qtyAccesSumsList[curindex] = qtyAccesSumsList[curindex] - IVcashrw.Quant;  			 	          end;  			 	        end else begin  			 	          curindex = IVcashrw.ArtCode & ";" & INr.BarCode;  			 	          if (IVcashrw.Quant>0) then begin  			 	            qtyAccesSumsList[curindex] = qtyAccesSumsList[curindex] + IVcashrw.Quant;  			 	          end else begin  			 	            qtyAccesSumsList[curindex] = qtyAccesSumsList[curindex] - IVcashrw.Quant;  			 	          end;  			 	        end;		 	          			 	      end;  			 	    end else begin  			 	      curindex = IVcashrw.ArtCode;  			 	      //vectors for sale		 	          if (IVcashrw.Quant>0) then begin				 	        qtyAccesOthersCodes[curindex] = qtyAccesOthersCodes[curindex] + IVcashrw.Quant;				 	        serNrAccesOthersCodes[curindex] = IVcashr.SerNr;				 	        priceAccesOthersCodes[curindex] = IVcashrw.Price;      			 	  end else begin      			 	    qtyAccesOthersCodes[curindex] = qtyAccesOthersCodes[curindex] - IVcashrw.Quant;      			 	  end;      			 	  //vector for inventory		 	          if (IVcashrw.Quant>0) then begin		 	            qtyAccesOthersList[IVcashrw.ArtCode] = qtyAccesOthersList[IVcashrw.ArtCode] + IVcashrw.Quant; 		 	          end else begin		 	            qtyAccesOthersList[IVcashrw.ArtCode] = qtyAccesOthersList[IVcashrw.ArtCode] - IVcashrw.Quant;		 	          end;  			 	    end;  			 	  end;  			  end;  			end;  	    	end;    end;        StartFormat(15); //SET header      OutString(0,0,SFtpb.SenderCode,false);      OutString(0,0,salesdate,false);      OutString(0,0,invoiceCnt,false); //Visitors      OutString(0,0,invoiceCnt,false); //Customers    EndFormat;    StartFormat(15);      OutString(0,0,"Серийный номер",false);      OutString(0,0,"Цена товара",false);      OutString(0,0,"ФИО Покупателя",false);      OutString(0,0,"Номер телефона покупателя",false);      OutString(0,0,"Адрес электронной почты",false);      OutString(0,0,"Номер чека",false);      OutString(0,0,"Номер участника программы",false);      OutString(0,0,"Номер купона",false);    EndFormat;    GetVectorTags(qtySetCodes,indexes);		for(i=0;i<indexes.length;i=i+1) begin //SET items			curindex = indexes[i];			pos = 0;			ExtractObjWithSeparator(";",curindex,false,pos,itemCode);			ExtractObjWithSeparator(";",curindex,false,pos,identificator);			if (qtySetCodes[curindex]>0) then begin  			StartFormat(15);          OutString(0,0,identificator,false);          tstr = ValToString(priceSetCodes[curindex],M4Val,"",SysFormatRec.decimalPt,0);          OutString(0,0,tstr,false);          OutString(0,0,"",false);          OutString(0,0,"",false);          OutString(0,0,"",false);          OutString(0,0,serNrSetCodes[curindex],false);          OutString(0,0,"",false);          OutString(0,0,"",false);        EndFormat;  			end;		end;				StartFormat(15); //Accessory header      OutString(0,0,"Код модели",false);      OutString(0,0,"Количество продаж",false);      OutString(0,0,"Цена товара",false);      OutString(0,0,"ФИО Покупателя",false);      OutString(0,0,"Номер телефона покупателя",false);      OutString(0,0,"Бренд",false);      OutString(0,0,"Адрес электронной почты",false);      OutString(0,0,"Номер чека",false);      OutString(0,0,"Номер участника программы",false);      OutString(0,0,"Номер купона",false);    EndFormat;    GetVectorTags(qtyAccesSumsCodes,indexes); //Accessory Samsung		for(i=0;i<indexes.length;i=i+1) begin			curindex = indexes[i];			pos = 0;			ExtractObjWithSeparator(";",curindex,false,pos,itemCode);			ExtractObjWithSeparator(";",curindex,false,pos,identificator);			if (qtyAccesSumsCodes[curindex]>0) then begin  			StartFormat(15);          OutString(0,0,identificator,false);          OutString(0,0,qtyAccesSumsCodes[curindex],false); 	        tstr = ValToString(priceAccesSumsCodes[curindex],M4Val,"",SysFormatRec.decimalPt,0); 	        OutString(0,0,tstr,false); 	        OutString(0,0,"",false); 	        OutString(0,0,"",false); 	        OutString(0,0,"Samsung",false); 	        OutString(0,0,"",false); 	        OutString(0,0,serNrSetCodes[curindex],false); 	        OutString(0,0,"",false); 	        OutString(0,0,"",false);        EndFormat;  			end;		end;		GetVectorTags(qtyAccesOthersCodes,indexes); //Accessory Others		for(i=0;i<indexes.length;i=i+1) begin			curindex = indexes[i];			pos = 0;			//ExtractObjWithSeparator(";"curindex,false,pos,itemCode);			//ExtractObjWithSeparator(";",curindex,false,pos,identificator);			if (qtyAccesOthersCodes[curindex]>0) then begin  			StartFormat(15);          OutString(0,0,curindex,false);          OutString(0,0,qtyAccesOthersCodes[curindex],false); 	        tstr = ValToString(priceAccesOthersCodes[curindex],M4Val,"",SysFormatRec.decimalPt,0); 	        OutString(0,0,tstr,false); 	        OutString(0,0,"",false); 	        OutString(0,0,"",false); 	        OutString(0,0,"Others",false); 	        OutString(0,0,"",false); 	        OutString(0,0,serNrAccesOthersCodes[curindex],false); 	        OutString(0,0,"",false); 	        OutString(0,0,"",false);        EndFormat;  			end;		end;            StartFormat(15); //Inventory header      OutString(0,0,"Код модели",false);      OutString(0,0,"Кол-во остатков",false);      OutString(0,0,"Тип продукта",false);      OutString(0,0,"Бренд",false);    EndFormat;    GetVectorTags(qtySetList,indexes); //Inventory Set-Samsung		for(i=0;i<indexes.length;i=i+1) begin			curindex = indexes[i];			pos = 0;			ExtractObjWithSeparator(";",curindex,false,pos,itemCode);			ExtractObjWithSeparator(";",curindex,false,pos,identificator);			ISr.Code = itemCode;			ISr.Location = locations;			if (ReadFirstMain(ISr,2,true) and (ISr.Instock - qtySetList[curindex]>=0)) then begin  			StartFormat(15);          OutString(0,0,identificator,false); 	        OutString(0,0,ISr.Instock - qtySetList[curindex],false); 	        OutString(0,0,"Set",false); 	        OutString(0,0,"Samsung",false);        EndFormat;  			end;		end;		GetVectorTags(qtyAccesSumsList,indexes); //Inventory Accessory-Samsung		for(i=0;i<indexes.length;i=i+1) begin			curindex = indexes[i];			pos = 0;			ExtractObjWithSeparator(";",curindex,false,pos,itemCode);			ExtractObjWithSeparator(";",curindex,false,pos,identificator);			ISr.Code = itemCode;			ISr.Location = locations;			if (ReadFirstMain(ISr,2,true) and (ISr.Instock - qtyAccesSumsList[curindex]>=0)) then begin  			StartFormat(15);          OutString(0,0,identificator,false); 	        OutString(0,0,ISr.Instock - qtyAccesSumsList[curindex],false); 	        OutString(0,0,"Accessory",false); 	        OutString(0,0,"Samsung",false);        EndFormat;  			end;		end;    GetVectorTags(qtyAccesOthersCodes,indexes); //Inventory Accessory-Others		for(i=0;i<indexes.length;i=i+1) begin			curindex = indexes[i];			pos = 0;			//ExtractObjWithSeparator(";"curindex,false,pos,itemCode);			//ExtractObjWithSeparator(";",curindex,false,pos,identificator);			ISr.Code = curindex;			ISr.Location = locations;			if (ReadFirstMain(ISr,2,true) and (ISr.Instock - qtyAccesOthersCodes[curindex]>=0)) then begin  			StartFormat(15);          OutString(0,0,curindex,false);          OutString(0,0,ISr.Instock - qtyAccesSumsList[curindex],false); 	        OutString(0,0,"Accessory",false); 	        OutString(0,0,"Others",false);        EndFormat;  			end;		end;   LSamsungSendFilesByMailMn:;      return;end;